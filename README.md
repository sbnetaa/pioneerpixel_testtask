# pioneerpixel_testtask
Test task for Pioneer Pixel

# Проект управления пользователями

## Описание

Это приложение представляет собой REST API для управления пользователями, их счетами, email'ами и телефонами. Приложение разработано в рамках тестового задания на позицию Java разработчика.

## Стек технологий

*   **Java 24**: Язык программирования.
*   **Spring Boot**: Фреймворк для быстрого создания Spring-приложений.
*   **PostgreSQL**: Реляционная база данных для хранения основной информации о пользователях.
*   **Spring Data JPA**: Для работы с базой данных PostgreSQL.
*   **Hibernate**: Имплементация JPA.
*   **Elasticsearch**: Поисковый движок для реализации функционала поиска пользователей с фильтрацией.
*   **Spring Data Elasticsearch**: Для интеграции с Elasticsearch.
*   **Redis**: In-memory хранилище данных, используемое для кэширования.
*   **Spring Data Redis**: Для интеграции с Redis.
*   **Spring Security**: Для обеспечения безопасности и аутентификации с использованием JWT.
*   **JWT (JSON Web Tokens)**: Механизм токенов для аутентификации без сохранения состояния.
*   **Maven**: Инструмент для сборки проекта и управления зависимостями.
*   **Lombok**: Библиотека для сокращения boilerplate-кода.
*   **Springdoc OpenAPI (Swagger)**: Для автоматической генерации документации API и интерактивного UI.
*   **Testcontainers**: Для интеграционных тестов с реальными сервисами (PostgreSQL, Elasticsearch, Redis) в Docker-контейнерах.
*   **JUnit 5**: Фреймворк для написания юнит-тестов.
*   **Mockito**: Фреймворк для создания моков в юнит-тестах.
*   **Logback/SLF4J**: Для логгирования в приложении.

## Инструкции по запуску проекта

Для запуска проекта убедитесь, что у вас установлены:

*   Java Development Kit (JDK) версии 24.
*   Apache Maven.
*   Docker и Docker Compose (для запуска зависимых сервисов).

1.  **Клонируйте репозиторий:**

    ```bash
    git clone https://github.com/sbnetaa/pioneerpixel_testtask.git
    cd pionerpixel-testtask
    ```

2.  **Настройте переменные окружения или `application.yml`:**

    Настройте подключение к базе данных PostgreSQL, Elasticsearch и Redis. Пример конфигурации приведен в разделе "Базовая конфигурация" в файлах проекта. Убедитесь, что значения `app.jwtSecret` и `app.jwtExpirationInMs` установлены.

3.  **Запустите зависимые сервисы с помощью Docker Compose:**

    Создайте файл `docker-compose.yml` в корне проекта (пример содержимого ниже) и выполните:

    ```bash
    docker-compose up -d
    ```

    Пример `docker-compose.yml`:

    ```yaml
    version: '3.8'

    services:
      postgres:
        image: postgres:14
        environment:
          POSTGRES_DB: your_database_name
          POSTGRES_USER: your_username
          POSTGRES_PASSWORD: your_password
        ports:
          - "5432:5432"
        volumes:
          - postgres_data:/var/lib/postgresql/data

      elasticsearch:
        image: elasticsearch:8.13.2
        environment:
          - discovery.type=single-node
          - xpack.security.enabled=false # Отключаем безопасность для простоты в тестовом задании
        ports:
          - "9200:9200"
        volumes:
          - elasticsearch_data:/usr/share/elasticsearch/data

      redis:
        image: redis:7.2.4
        ports:
          - "6379:6379"
        volumes:
          - redis_data:/data

    volumes:
      postgres_data:
      elasticsearch_data:
      redis_data:
    ```

    Замените `your_database_name`, `your_username`, `your_password` на свои значения.

4.  **Соберите и запустите приложение:**

    Используя Maven, выполните:

    ```bash
    mvn clean install
    mvn spring-boot:run
    ```

    Приложение запустится на порту 8080 (если не изменено в конфигурации).

5.  **Доступ к Swagger UI:**

    Документация API будет доступна по адресу `http://localhost:8080/swagger-ui.html`.

## Логика принятых решений

*   **Структура проекта:** Приложение разделено на стандартные слои API (контроллеры), Service (бизнес-логика) и DAO (доступ к данным).
*   **База данных:** PostgreSQL выбрана как надежная реляционная СУБД. Связи между таблицами реализованы с использованием аннотаций JPA. Для `date_of_birth` использован тип `LocalDate` для корректной работы с датами без времени. Для `balance` и `initial_deposit` использован `BigDecimal` для точных финансовых расчетов.
*   **Elasticsearch для поиска:** Elasticsearch используется для эффективного полнотекстового поиска и фильтрации пользователей, что более оптимально для таких задач по сравнению с чистым SQL-поиском, особенно при росте объема данных. Фильтрация по `date_of_birth` реализована как "больше чем", по `phone` и `email` - как точное совпадение (используя `Keyword` тип в индексе), по `name` - как поиск по префиксу (используя `startsWith` в CriteriaQuery).
*   **Redis для кэширования:** Redis используется для кэширования часто запрашиваемых данных (например, информация о пользователях по ID), что снижает нагрузку на базу данных и улучшает производительность. Использованы аннотации `@Cacheable` и `@CacheEvict`.
*   **Spring Security и JWT:** Выбрана простая реализация JWT для аутентификации без сохранения состояния. Аутентификация происходит по email или телефону и паролю. В токене хранится только `USER_ID`. Механизм получения токена реализован через отдельный эндпоинт `/api/auth/signin`.
*   **Операция трансфера денег:** Реализована как транзакционная операция с изоляцией `SERIALIZABLE` для предотвращения гонок данных. Для дополнительной потоко-защиты на уровне приложения используется `ReentrantLock`. Проводятся необходимые валидации (положительная сумма, разные пользователи, достаточный баланс).
*   **Увеличение баланса по расписанию:** Реализовано с использованием `@Scheduled` аннотации Spring. Баланс увеличивается на 10% каждые 30 секунд, но не более чем на 207% от начального депозита.
*   **Валидация входных данных:** Используются аннотации Jakarta Bean Validation (`@NotBlank`, `@Size`, `@Pattern`, `@Positive`, `@NotNull`) для валидации входных DTO.
*   **Логгирование:** Настроено значимое логгирование с использованием Logback. Логи пишутся в консоль и файл, с ротацией по дням. Логгируются важные события и ошибки в различных слоях приложения.
*   **Swagger:** Добавлена базовая конфигурация Springdoc OpenAPI для документирования API, что облегчает тестирование и интеграцию.
*   **Миграции БД:** В тестовом задании указано, что пользователи создаются миграциями. В данной реализации это не включено для простоты, но в реальном проекте рекомендуется использовать инструменты типа Liquibase или Flyway для управления схемой БД и начальным наполнением данными.
*   **Тестирование:** Реализованы юнит-тесты для трансфера денег и интеграционный тест с Testcontainers для API эндпоинта с использованием MockMvc.

## Тестирование

*   **Юнит-тесты:** Тесты для функционала трансфера денег написаны с использованием JUnit 5 и Mockito.
*   **Интеграционные тесты:** Один из API эндпоинтов покрыт тестами с использованием Testcontainers для запуска реальных баз данных и MockMvc для вызова API.
